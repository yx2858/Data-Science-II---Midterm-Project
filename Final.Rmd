---
title: "temp title"
author: "Jixin Li (jl6648), Alex McCreight (apm2217), Yueyi Xu (yx2858)"
output: pdf_document
date: "Spring 2024"
geometry: margin=1in
fontsize: 12pt
spacing: double
bibliography: Library.bib
csl: vancouver-superscript.csl
---

```{r libraries-data-cleaning, include = F}
library(tidyverse)
library(glmnet)
library(caret)
library(tidymodels)
library(pls)
library(corrplot)
library(knitr)
library(patchwork)


load("recovery.RData")

dat$gender <- as.factor(dat$gender)
dat$race <- as.factor(dat$race)
dat$smoking <- as.factor(dat$smoking)
dat$hypertension <- as.factor(dat$hypertension)
dat$diabetes <- as.factor(dat$diabetes)
dat$vaccine <- as.factor(dat$vaccine)
dat$severity <- as.factor(dat$severity)
dat$study <- as.factor(dat$study)

dat <- dat %>%
  select(-id) %>% 
  mutate(
    gender = case_when(
      dat$gender == 1 ~ "Male",
      TRUE ~ "Female"),
    race = case_when(
      dat$race == 1 ~ "White",
      dat$race == 2 ~ "Asian",
      dat$race == 3 ~ "Black",
      TRUE ~ "Hispanic"),
    smoking = case_when(
      dat$smoking == 0 ~ "Never Smoked",
      dat$smoking == 1 ~ "Former Smoker",
      TRUE ~ "Current Smoker")) %>% 
  mutate_if(is.character, as.factor) %>% 
  mutate(race = relevel(race, ref = "White"),
         smoking = relevel(smoking, ref = "Never Smoked"),
         study = relevel(study, ref = "B"))
```

## Introduction

The severe acute respiratory syndrome coronavirus 2 (SARS-CoV-2) was first identified in China in December 2019. Since then, the COVID-19 pandemic poses a significant public health threat, particularly affecting older adults and individuals with chronic health conditions. Factors such as age, gender, vaccination status, the severity of COVID-19 symptoms, and pre-existing chronic illnesses play a crucial role in determining the recovery time for patients[@Factors].

In this project, we use statistical methods and fit models based on factors that potentially affect COVID-19 recovery time. We begin by examining the data and selecting appropriate variables for modeling. Next, we fit and train multiple models and evaluate their test errors to compare their accuracy. In the end, we choose the MARS model due to its lowest test error, ensuring accurate prediction of COVID-19 recovery time.

## Exploratory analysis and data visualization

With the goals of developing a prediction model for COVID-19 recovery time and identifying important risk factors for long recovery in mind, we first ran an exploratory analysis of all variables in our data set to visualize their relationship with recovery time. Our findings revealed that recovery time has a small positive correlation with age and weight, and a slightly stronger positive association with BMI. Conversely, height has a small negative relationship with recovery time.

Among the discrete variables, we observed substantial differences in recovery time based on vaccination status as well as COVID-19 severity. Individuals who received the COVID-19 vaccine had shorter recovery times, on average, compared to those who have not received the vaccine (Figure 1a). Additionally, those with "severe" COVID-19 had longer recovery times, on average, compared to those with "non-severe" COVID-19 (Figure 1b).

```{r, echo=FALSE}
p1 <- dat %>%
  mutate(vaccine = case_when(
    dat$vaccine == 1 ~ "Vaccinated",
    TRUE ~ "Not vaccinated"
  )) %>% 
  ggplot(aes(x = vaccine, y = recovery_time)) +
    geom_boxplot() +
    theme_classic() + 
    labs(x = "Vaccination Status at Time of Infection", y = "Recovery Time (in days)", title = "Figure 1a")

p2 <- dat %>%
  mutate(severity = case_when(
    dat$severity == 1 ~ "Severe",
    TRUE ~ "Not severe"
  )) %>% 
  ggplot(aes(x = severity, y = recovery_time)) +
    geom_boxplot() +
    theme_classic() + 
    labs(x = "Severity of COVID-19 infection", y = "Recovery Time (in days)", title = "Figure 1b")

p1 + p2
```




Interestingly, we found a saw that those with diabetes had a shorter time to recovery compared to those without diabetes, which immediately seems counter intuitive (Figure 2). However, upon further literature review, we posit that those with diabetes in these studies either died more quickly compared to those without diabetes, or those with long-COVID and lived most likely had well-managed diabetes and took extra precautions against COVID-19 compared to those without diabetes[@diabetes].

Finally, we observed a significant difference in the variability of recovery times of participants in study A versus study B. The exact reasons for this discrepancy are unclear, however, we hypothesize that study A was conducted when the vaccines were more available leading to reduced variability in recovery time compared to study B. 

```{r, echo = F}
dat %>%
  mutate(diabetes = case_when(
    dat$diabetes == 1 ~ "Has Diabetes",
    TRUE ~ "No Diabetes"
  )) %>% 
  ggplot(aes(x = diabetes, y = recovery_time)) +
    geom_boxplot() +
    theme_classic() + 
    labs(x = "Diabetes Status", y = "Recovery Time (in days)", title = "Figure 2: Diabetes Status vs Time to Recovery")
```

  
## Model training

In the pursuit of predicting the time to recovery from COVID-19, a series of statistical and machine learning models were deployed, each with unique characteristics and assumptions. Here's a detailed description of each model used in this context:

LASSO Regression: This model applies L1 regularization to reduce the risk of overfitting by penalizing large coefficients. It's particularly useful for models with a high number of predictors, as it can help in feature selection by shrinking some coefficients to zero.

Ridge Regression: Similar to LASSO, Ridge applies L2 regularization. It's used to prevent overfitting by penalizing large coefficients, but unlike LASSO, it does not set them to zero.

Elastic Net: This combines the properties of both LASSO and Ridge regression, using both L1 and L2 regularization. It's useful when there are correlations among predictors.

Partial Least Squares (PLS): PLS is a method that projects both the predictors and the responses to a new space formed by orthogonal components that maximize the covariance between the response and the predictors.

Multivariate Adaptive Regression Splines (MARS): MARS is a non-linear regression technique that can model complex interactions between variables. It's flexible and can capture non-linear relationships without prior specification.

Model Training Procedure:
1. Data Partitioning: The dataset 'dat' and a subset 'dat_subset' are divided into training (80%) and testing (20%) sets to ensure models are evaluated on unseen data.

2. Feature Engineering: Model matrices are created from the training data, excluding the response variable for direct use in the models.

3. Model Tuning and Training: For each model type (LASSO, Ridge, Elastic Net, PLS, MARS), the 'train' function from the 'caret' package is used with a grid of hyperparameters to find the best settings through cross-validation. The process involves:
- Specifying a tuning grid for model parameters (e.g. 'lambda' for regularization strength, 'alpha' for the mix between LASSO and Ridge in Elastic Net).
- Using repeated cross-validation to assess model performance and select the best hyperparameters ('ctrl_SE' for models where selection is based on the one-standard error rule, and 'ctrl_best' for models choosing the best performance).

4. Model Evaluation: Models are evaluated using Resampling statistics (resamp) and comparison of RMSE (Root Mean Square Error) across all models using both the full dataset and the subset.

Final Model Selection:
The final model selection involves comparing the RMSE of each model on the test dataset. The models are ranked based on their performance (lower RMSE values indicate better performance), and the best-performing model(s) can be chosen for further analysis or deployment. 

## Results

The MARS model was selected as the best model for prediction because it achieved the lowest RMSE, which is 17.51607, indicates it would have the best predictive performance. According to the coefficient results, 
the recovery time is 34.9 days when all predictor variables are zero; For every centimeter increase in height from 159.7, the recovery time increases by approximately 9.34 days; For every kilograms increase in weight from 77.8, the recovery time increases by approximately 0.62 days; people who are vaccinated experience a reduced recovery time by approximately 6.7 days compared to those who are not vaccinated; people who have severe symptoms experience a increased recovery time by approximately 7.5 days compared to those who don't have severe symptoms. Therefore, we can conclude that factors such as height, weight, vaccination, and severity are significant factors that affect COVID-19 patients' recovery time.

Table 1: Comparison of RMSE values for different models.
|     Model             |       RMSE       | 
|-----------------------|------------------|
| MARS (Subset)         |     17.51607     |    
| MARS                  |     17.90665     |    
| PLS                   |     18.38267	   |         
| Elastic Net           |     18.40800	   |
| LASSO                 |    	19.01320	   |
| Ridge                 |     19.83322     |
| Ridge (Subset)        |     20.13261	   |
| Elastic Net (Subset)  |     20.13263	   |
| PLS (Subset)          |     20.14682     |
| LASSO (Subset)        |     20.82849     |

Table 2: Coefficients results for MARS model.
|               Variable                    |  coefficients    | 
|-------------------------------------------|------------------|
| (Intercept)                               |    34.88323690   |    
| h(159.7-height)                           |     9.34309220   |    
| h(159.7-height) * h(weight-81.1)          |     5.76534263   |         
| h(159.7-height) * h(weight-81.1) * studyA |    -5.30476432   |
| h(weight-77.8)                            |     0.61871036 	 |
| h(171.7-height) * h(weight-77.8)          |     0.58372420   |
| vaccine1                                  |    -6.70694245   |
| h(171.7-height) * h(weight-77.8) * studyA |    -0.39375665   |
| severity1                                 |     7.54439179   |
| h(height-159.7) * h(87.3-weight)          |     0.05074098   |
| h(159.7-height) * studyA                  |    -7.18027109   |

```{r, inlcude=FALSE}
set.seed(1)
trainIndex_sub <- createDataPartition(dat_subset$recovery_time, p = 0.8, list = FALSE)
training_data_sub <- dat_subset[trainIndex, ]
testing_data_sub <- dat_subset[-trainIndex, ]

ctrl_best <- trainControl(method = "repeatedcv",
                      number = 10,
                      repeats = 5,
                      selectionFunction = "best")

x_sub <- model.matrix(recovery_time ~ ., training_data_sub)[, -1]
y_sub <- training_data_sub$recovery_time

# MARS Sub

mars_fit_sub <- train(x = x_sub,
                  y = y_sub,
                 method = "earth",
                 tuneGrid = mars_grid,
                 metric = "RMSE",
                 trControl = ctrl_best)

ggplot(mars_fit_sub) + theme_classic()

mars_fit_sub$bestTune
coef(mars_fit_sub$finalModel)
```


## Conclusions

In this section, summarize your findings from the model analysis and discuss the insights gained into predicting time to recovery from COVID-19.

### Additional Considerations

In your modeling efforts, did you include "study" as a predictor variable? Provide a rationale for your decision, considering the variable's relevance and potential impact on model accuracy and interpretability.

## References